<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Pianoshock 2 Pro - Ultimate Edition</title>
<script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.27/build/Midi.js"></script>
<style>
  :root {
    --bg: #0b0b0e;
    --panel: #1a1a20;
    --accent: #00e5ff; /* „Éç„Ç™„É≥„Éñ„É´„Éº */
    --learn: #ff9100;  /* ÊïôËÇ≤Áî®„Ç™„É¨„É≥„Ç∏ */
    --danger: #ff4d4d;
    --text: #e0e0e0;
  }

  body {
    margin: 0;
    background: var(--bg);
    font-family: 'Helvetica Neue', Arial, sans-serif;
    color: var(--text);
    overflow: hidden;
    user-select: none;
    touch-action: none;
  }

  /* „É°„Ç§„É≥„É¨„Ç§„Ç¢„Ç¶„Éà */
  #app { display: flex; flex-direction: column; height: 100vh; }

  #header {
    background: var(--panel);
    padding: 15px 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.8);
    border-bottom: 2px solid var(--accent);
    z-index: 100;
  }

  h1 {
    margin: 0 0 15px 0;
    font-size: 1rem;
    letter-spacing: 4px;
    color: var(--accent);
    text-transform: uppercase;
    text-align: center;
  }

  .controls {
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  button, .file-label {
    padding: 10px 14px;
    border-radius: 8px;
    border: 1px solid #333;
    background: #2a2a35;
    color: white;
    cursor: pointer;
    font-weight: 600;
    font-size: 11px;
    transition: 0.2s;
  }

  button:hover { background: var(--accent); color: #000; border-color: var(--accent); }
  button.active-mode { background: var(--danger); animation: pulse 1.5s infinite; }
  button.calib-mode { background: #ffcc00; color: #000; }

  /* ÊïôËÇ≤„Éë„Éç„É´ */
  #edu-panel {
    background: #22222b;
    padding: 10px;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    border-bottom: 1px solid #333;
  }
  .edu-btn { border-color: var(--learn); color: var(--learn); }
  .edu-btn:hover { background: var(--learn); color: #000; }

  /* ÈçµÁõ§„Ç®„É™„Ç¢ */
  #keyboard-container {
    flex-grow: 1;
    overflow-x: auto;
    background: #000;
    display: flex;
    align-items: center;
    padding: 20px 0;
  }

  #keyboard {
    position: relative;
    width: 2100px; /* 88Èçµ„ÅÆÂêàË®àÂπÖ */
    height: 280px;
    margin: 0 auto;
  }

  .white {
    position: absolute;
    width: 40px;
    height: 250px;
    background: linear-gradient(to bottom, #eee 0%, #fff 100%);
    border: 1px solid #111;
    z-index: 1;
    border-radius: 0 0 6px 6px;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    padding-bottom: 10px;
    color: #999;
    font-size: 12px;
    font-weight: bold;
  }

  .black {
    position: absolute;
    width: 26px;
    height: 150px;
    background: linear-gradient(to bottom, #333 0%, #000 100%);
    border: 1px solid #000;
    z-index: 2;
    border-radius: 0 0 4px 4px;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    padding-bottom: 8px;
    color: #fff;
    font-size: 9px;
  }

  /* Áä∂ÊÖãË°®Á§∫„ÇØ„É©„Çπ */
  .active { background: var(--accent) !important; box-shadow: 0 0 30px var(--accent) !important; color: #000 !important; transform: translateY(2px); }
  .guide { background: var(--learn) !important; animation: blink 1s infinite; color: #000 !important; }

  @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
  @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

  #status-bar { padding: 5px; text-align: center; font-size: 12px; background: #000; color: #666; }
  .val { color: var(--accent); font-weight: bold; }
</style>
</head>
<body>

<div id="app">
  <div id="header">
    <h1>Pianoshock 2 Pro <small>Ultimate</small></h1>
    <div class="controls">
      <button id="start">1. AUDIO ON</button>
      <button id="midi-conn">2. MIDI CONNECT</button>
      <button id="calibrate">SET MIDDLE C</button>
      <button id="rec-audio">REC WAV</button>
      <button id="rec-midi">REC MIDI</button>
      <label class="file-label" for="upload">UPLOAD MIDI</label>
      <input type="file" id="upload" accept=".mid">
      <button id="playMidi">PLAY</button>
      <button id="roombaMode">ü§ñ ROOMBA OFF</button>
<button id="roombaConnect" disabled>CONNECT ROOMBA</button>
    </div>
  </div>

  <div id="edu-panel">
    <span style="font-size:12px; font-weight:bold;">üéì LEARN:</span>
    <button class="edu-btn" onclick="setGuide('scale')">Do-Re-Mi</button>
    <button class="edu-btn" onclick="setGuide('c-maj')">C Chord</button>
    <button class="edu-btn" onclick="setGuide('f-maj')">F Chord</button>
    <button class="edu-btn" onclick="setGuide('g-maj')">G Chord</button>
    <button onclick="setGuide(null)" style="color:var(--danger)">OFF</button>
    <span id="guide-msg" style="color:var(--learn); font-size:12px; margin-left:10px;"></span>
  </div>

  <div id="keyboard-container">
    <div id="keyboard"></div>
  </div>

  <div id="status-bar">
    STATUS: <span id="st-text" class="val">READY</span> | 
    OFFSET: <span id="st-off" class="val">0</span> | 
    MIDI: <span id="st-midi" class="val">NONE</span>
  </div>
</div>

<script>
let activeNotes = {};
const MAX_VOICES = 10; // ‚Üê „Åì„Åì„ÅßÂà∂ÈôêÊï∞„ÇíÊ±∫„ÇÅ„Çã
let loadedMidi = null;
// ===== RoombaËøΩÂä† =====
let roombaMode = false;
let roombaPort = null;
let roombaWriter = null;
let synth, recorder, chunks = [];
let recordingMidi = false, recordedMidiNotes = [], midiStartTime;
let midiOffset = 0, isCalibrating = false;
const noteNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];

const guides = {
  'scale': [60, 62, 64, 65, 67, 69, 71, 72],
  'c-maj': [60, 64, 67],
  'f-maj': [65, 69, 72],
  'g-maj': [67, 71, 74]
};

/* 1. ÈçµÁõ§„ÅÆÁîüÊàê */
const keyboard = document.getElementById("keyboard");
const whitePattern = [0, 2, 4, 5, 7, 9, 11];
let whiteIndex = 0;

for (let n = 21; n <= 108; n++) {
  const isWhite = whitePattern.includes(n % 12);
  const key = document.createElement("div");
  key.className = isWhite ? "white" : "black";
  key.dataset.note = n;
  key.innerHTML = `<span>${noteNames[n % 12]}</span>`;
  
  if (isWhite) {
    key.style.left = (whiteIndex * 40) + "px";
    whiteIndex++;
  } else {
    const whitesBefore = [...keyboard.children].filter(k => k.className === "white").length;
    key.style.left = (whitesBefore * 40 - 13) + "px";
  }

  // „Éû„Ç¶„Çπ/„Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„Éà
  const startPlay = (e) => { e.preventDefault(); noteOn(n - midiOffset); };
  const stopPlay = (e) => { e.preventDefault(); noteOff(n - midiOffset); };
  key.addEventListener("mousedown", startPlay);
  key.addEventListener("mouseup", stopPlay);
  key.addEventListener("touchstart", startPlay, {passive: false});
  key.addEventListener("touchend", stopPlay, {passive: false});
  
  keyboard.appendChild(key);
}

/* 2. Èü≥Â£∞ÂàùÊúüÂåñ */
document.getElementById("start").onclick = async () => {
  await Tone.start();
  const dest = Tone.context.createMediaStreamDestination();
  recorder = new MediaRecorder(dest.stream);
  
  synth = new Tone.Sampler({
    urls: { A0: "A0.mp3", C1: "C1.mp3", "D#1": "Ds1.mp3", "F#1": "Fs1.mp3", A1: "A1.mp3", C2: "C2.mp3", "D#2": "Ds2.mp3", "F#2": "Fs2.mp3", A2: "A2.mp3", C3: "C3.mp3", "D#3": "Ds3.mp3", "F#3": "Fs3.mp3", A3: "A3.mp3", C4: "C4.mp3", "D#4": "Ds4.mp3", "F#4": "Fs4.mp3", A4: "A4.mp3", C5: "C5.mp3", "D#5": "Ds5.mp3", "F#5": "Fs5.mp3", A5: "A5.mp3", C6: "C6.mp3", "D#6": "Ds6.mp3", "F#6": "Fs6.mp3", A6: "A6.mp3", C7: "C7.mp3", "D#7": "Ds7.mp3", "F#7": "Fs7.mp3", A7: "A7.mp3", C8: "C8.mp3" },
    release: 1,
    baseUrl: "https://tonejs.github.io/audio/salamander/"
  }).toDestination();
  
  synth.connect(dest);
  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.onstop = () => {
    const blob = new Blob(chunks, { type: 'audio/wav' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'piano_record.wav';
    a.click();
    chunks = [];
  };
  
  document.getElementById("start").style.background = "var(--accent)";
  document.getElementById("st-text").innerText = "AUDIO ACTIVE";
};

/* 3. ÊºîÂ•è„É≠„Ç∏„ÉÉ„ÇØ */
function noteOn(rawNote) {
  if (isCalibrating) {
    midiOffset = 60 - rawNote;
    document.getElementById("st-off").innerText = midiOffset;
    isCalibrating = false;
    document.getElementById("calibrate").classList.remove("calib-mode");
    return;
  }
  const note = rawNote + midiOffset;
  if (!synth || note < 21 || note > 108) return;
 const MAX_VOICES = 10; // ‚Üê Â•Ω„Åç„Å´Â§â„Åà„Å¶OKÔºà8„Äú16„ÅåÁèæÂÆüÁöÑÔºâ
  if (Object.keys(activeNotes).length >= MAX_VOICES) {
    return; // ‚Üê „Åì„Çå„Å†„Åë„Åß Rush E „ÅåËªΩ„Åè„Å™„Çã
  }

  synth.triggerAttack(Tone.Frequency(note, "midi"));
  const el = document.querySelector(`[data-note='${note}']`);
  if (el) el.classList.add("active");

  if (recordingMidi) {
    activeNotes[note] = Tone.now();
  }
}

function noteOff(rawNote) {
  const note = rawNote + midiOffset;
  if (!synth) return;
  synth.triggerRelease(Tone.Frequency(note, "midi"));
  const el = document.querySelector(`[data-note='${note}']`);
  if (el) el.classList.remove("active");

  if (recordingMidi && activeNotes[note]) {
    recordedMidiNotes.push({
      midi: note,
      time: activeNotes[note] - midiStartTime,
      duration: Tone.now() - activeNotes[note]
    });
    delete activeNotes[note];
  }
}

/* 4. ÊïôËÇ≤Ê©üËÉΩ */
function setGuide(type) {
  document.querySelectorAll('.white, .black').forEach(el => el.classList.remove('guide'));
  const notes = guides[type];
  if (notes) {
    notes.forEach(n => {
      const el = document.querySelector(`[data-note='${n}']`);
      if (el) el.classList.add('guide');
    });
    document.getElementById("guide-msg").innerText = "Highlighting keys...";
  } else {
    document.getElementById("guide-msg").innerText = "";
  }
}

/* 5. Èå≤Èü≥„ÉªMIDIÊìç‰Ωú */
document.getElementById("rec-audio").onclick = (e) => {
  if (!recorder) return;
  if (recorder.state === "inactive") {
    recorder.start();
    e.target.classList.add("active-mode");
  } else {
    recorder.stop();
    e.target.classList.remove("active-mode");
  }
};

document.getElementById("rec-midi").onclick = (e) => {
  if (!recordingMidi) {
    recordedMidiNotes = [];
    activeNotes = {};
    midiStartTime = Tone.now();
    recordingMidi = true;
    e.target.classList.add("active-mode");
  } else {
    recordingMidi = false;
    e.target.classList.remove("active-mode");
    const m = new Midi();
    const t = m.addTrack();
    recordedMidiNotes.forEach(n => t.addNote(n));
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([m.toArray()], {type: "audio/midi"}));
    a.download = "composition.mid";
    a.click();
  }
};
document.getElementById("upload").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const arrayBuffer = await file.arrayBuffer();
  loadedMidi = new Midi(arrayBuffer);

  document.getElementById("st-text").innerText = "MIDI LOADED";
});
/* 6. MIDIÊé•Á∂ö & „Ç≠„É£„É™„Éñ„É¨„Éº„Ç∑„Éß„É≥ */
document.getElementById("midi-conn").onclick = async () => {
  const access = await navigator.requestMIDIAccess();
  for (let input of access.inputs.values()) {
    document.getElementById("st-midi").innerText = input.name;
    input.onmidimessage = e => {
      const [cmd, note, vel] = e.data;
      if (cmd === 144 && vel > 0) noteOn(note);
      else if (cmd === 128 || (cmd === 144 && vel === 0)) noteOff(note);
    };
  }
};

document.getElementById("calibrate").onclick = (e) => {
  isCalibrating = true;
  e.target.classList.add("calib-mode");
  document.getElementById("st-text").innerText = "PRESS MIDDLE C ON KEYBOARD";
};

/* 7. „Ç≠„Éº„Éú„Éº„ÉâÂÖ•Âäõ */
const pcKeys = { a:60, w:61, s:62, e:63, d:64, f:65, t:66, g:67, y:68, h:69, u:70, j:71, k:72 };
document.addEventListener("keydown", e => { if(pcKeys[e.key] && !e.repeat) noteOn(pcKeys[e.key] - midiOffset); });
document.addEventListener("keyup", e => { if(pcKeys[e.key]) noteOff(pcKeys[e.key] - midiOffset); });
document.getElementById("playMidi").onclick = async () => {
  if (!loadedMidi || !synth) {
    alert("MIDI „ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ");
    return;
  }

  const now = Tone.now();

  loadedMidi.tracks.forEach(track => {
    track.notes.forEach(note => {
      const t = now + note.time;
      const midi = note.midi;

      // Èü≥„ÇíÈ≥¥„Çâ„Åô
      synth.triggerAttackRelease(
        Tone.Frequency(midi, "midi"),
        note.duration,
        t
      );

      // ÈçµÁõ§„ÇíÂÖâ„Çâ„Åõ„Çã
      const el = document.querySelector(`[data-note='${midi}']`);
      if (el) {
        setTimeout(() => el.classList.add("active"), note.time * 1000);
        setTimeout(() => el.classList.remove("active"), (note.time + note.duration) * 1000);
      }
    });
  });

  document.getElementById("st-text").innerText = "PLAYING MIDI...";
};
  // ===== Roomba„É¢„Éº„ÉâÂàáÊõø =====
document.getElementById("roombaMode").onclick = function(){
  roombaMode = !roombaMode;
  this.textContent = roombaMode ? "ü§ñ ROOMBA ON" : "ü§ñ ROOMBA OFF";
  document.getElementById("roombaConnect").disabled = !roombaMode;
};

// ===== RoombaÊé•Á∂ö =====
document.getElementById("roombaConnect").onclick = async () => {
  try{
    roombaPort = await navigator.serial.requestPort();
    await roombaPort.open({ baudRate:115200 });
    roombaWriter = roombaPort.writable.getWriter();

    // Start + Safe
    await roombaWriter.write(new Uint8Array([128]));
    await roombaWriter.write(new Uint8Array([131]));

    alert("Roomba Connected!");
  }catch(e){
    alert("connect error");
  }
};
</script>
</body>
</html>




